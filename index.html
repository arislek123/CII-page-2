<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MaritimeCII</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --navy:#0B2A4A;
      --navy2:#103457;
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e8eef6;
      --muted:#6b7a90;
      --text:#0f172a;
      --shadow: 0 10px 30px rgba(16,52,87,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:28px 18px;}
    /* NAV */
    .nav{
      background: var(--navy);
      color:#fff;
      position:sticky; top:0; z-index:50;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    .nav-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .brand-badge{
      width:32px; height:32px; border-radius:10px;
      background: rgba(255,255,255,.12);
      display:grid; place-items:center;
    }
    .nav-links{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .tab{
      padding:9px 14px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      color: rgba(255,255,255,.82);
      transition:.15s;
    }
    .tab:hover{background: rgba(255,255,255,.10); color:#fff}
    .tab.active{background: rgba(255,255,255,.14); color:#fff}

    /* PAGE */
    h1{font-size:34px; margin: 12px 0 6px}
    .subtitle{color:var(--muted); margin:0 0 18px}
    .grid-2{display:grid; grid-template-columns: 1fr 1fr; gap:18px;}
    .grid-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:18px;}
    .grid-4{display:grid; grid-template-columns: repeat(4, 1fr); gap:14px;}
    @media (max-width: 980px){
      .grid-2,.grid-3{grid-template-columns:1fr}
      .grid-4{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 520px){
      .grid-4{grid-template-columns:1fr}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .card h3{
      margin:0 0 14px;
      display:flex; align-items:center; gap:10px;
      font-size:16px;
    }
    .icon{
      width:30px; height:30px; border-radius:10px;
      background: rgba(16,52,87,.08);
      display:grid; place-items:center;
      color: var(--navy2);
      font-weight:900;
      font-size:14px;
    }

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;}
    @media (max-width: 520px){.row{grid-template-columns:1fr}}
    label{display:block; font-size:12px; color: var(--muted); margin-bottom:6px; font-weight:700}
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid #dbe6f3;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    input:focus, select:focus{border-color: rgba(16,52,87,.55); box-shadow: 0 0 0 4px rgba(16,52,87,.12)}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}

    .kpi{
      text-align:center;
      padding:18px 12px;
    }
    .kpi .k{font-size:12px; color:var(--muted); font-weight:700}
    .kpi .v{font-size:30px; font-weight:900; margin-top:6px}
    .rating-pill{
      width:46px; height:46px;
      border-radius:999px;
      display:grid; place-items:center;
      margin:10px auto 0;
      font-weight:900;
      color:#fff;
      background:#ef4444;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition:.12s;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 10px 30px rgba(16,52,87,.10)}
    .btn.primary{
      background: var(--navy2);
      border-color: var(--navy2);
      color:#fff;
    }
    .btn.small{padding:8px 10px; border-radius:10px; font-size:12px}
    .btn.danger{background:#fff; border-color:#ffd1d1; color:#b91c1c}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
      font-size:13px;
    }
    th{color:var(--muted); text-align:left; font-size:12px; padding:0 10px;}
    td{padding: 10px; background:#fff; border:1px solid var(--border);}
    td:first-child{border-radius:12px 0 0 12px}
    td:last-child{border-radius:0 12px 12px 0}
    .td-input{padding:6px 8px}
    .td-input input{padding:8px 10px; border-radius:10px}
    .td-actions{display:flex; gap:8px; align-items:center; justify-content:flex-end}

    .section{display:none}
    .section.active{display:block}

    .chart-wrap{height:280px}
    .chart-wrap.tall{height:330px}
    canvas{max-width:100%}

    .flex{display:flex; gap:12px; align-items:center}
    .space-between{justify-content:space-between}
    .muted{color:var(--muted)}

    .footer{
      margin-top:42px;
      background: var(--navy);
      color: rgba(255,255,255,.7);
      text-align:center;
      padding:18px;
      font-size:13px;
    }

    /* WHO */
    .team-grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:18px;}
    @media (max-width: 980px){.team-grid{grid-template-columns:1fr}}
    .avatar{
      width:80px; height:80px; border-radius:999px;
      background: var(--navy2);
      color:#fff;
      display:grid; place-items:center;
      font-weight:900;
      font-size:22px;
      margin: 10px auto 12px;
    }
    .who-card h4{margin:0; text-align:center; font-size:18px}
    .who-card .role{margin-top:6px; text-align:center; font-size:13px; color:#2563eb; font-weight:800}
    .who-card p{margin:12px 0 0; color:var(--muted); font-size:13px; line-height:1.5}
    .center{ text-align:center }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand" onclick="go('cii')" style="cursor:pointer">
        <div class="brand-badge">‚öì</div>
        <div>MaritimeCII</div>
      </div>
      <div class="nav-links">
        <a class="tab active" id="tab-cii" href="#cii" onclick="go('cii')">CII Calculator</a>
        <a class="tab" id="tab-ets" href="#eu-ets" onclick="go('ets')">EU ETS</a>
        <a class="tab" id="tab-fueleu" href="#fueleu" onclick="go('fueleu')">FuelEU Maritime</a>
        <a class="tab" id="tab-who" href="#who" onclick="go('who')">Who We Are</a>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- ========================= CII ========================= -->
    <section id="page-cii" class="section active">
      <h1>CII Calculator</h1>
      <p class="subtitle">Carbon Intensity Indicator ‚Äî calculate your vessel's operational efficiency rating.</p>

      <div class="grid-2">
        <div class="card">
          <h3><span class="icon">‚öì</span> Ship Details</h3>

          <div class="row">
            <div>
              <label>Ship Type</label>
              <select id="ciiShipType" onchange="ciiRecalcAll()">
                <option value="bulk_carrier">Bulk Carrier</option>
                <option value="tanker">Tanker</option>
                <option value="container">Container Ship</option>
                <option value="gas_carrier">Gas Carrier</option>
                <option value="general_cargo">General Cargo</option>
                <option value="refrigerated_cargo">Refrigerated Cargo</option>
                <option value="ro_ro_cargo">Ro-Ro Cargo</option>
                <option value="ro_ro_passenger">Ro-Ro Passenger</option>
                <option value="cruise">Cruise</option>
              </select>
            </div>
            <div>
              <label>Reporting Year</label>
              <select id="ciiYear" onchange="ciiRecalcAll()">
                <option>2023</option>
                <option>2024</option>
                <option selected>2025</option>
                <option>2026</option>
                <option>2027</option>
                <option>2028</option>
                <option>2029</option>
                <option>2030</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Capacity (DWT)</label>
              <input id="ciiCapacity" type="number" value="180000" oninput="ciiRecalcAll()" />
            </div>
            <div>
              <label>Annual Distance (nm)</label>
              <input id="ciiDistance" type="number" value="10000" oninput="ciiRecalcAll()" />
            </div>
          </div>

          <div>
            <label>Correction Factor</label>
            <input id="ciiCorr" type="number" step="0.01" value="1" oninput="ciiRecalcAll()" />
            <div class="hint">Voyage adjustments, ice, electrical corrections. Use 1.0 if none apply.</div>
          </div>
        </div>

        <div class="card">
          <h3><span class="icon">‚õΩ</span> Fuel Consumption</h3>

          <table>
            <thead>
              <tr>
                <th style="width:34%">Fuel</th>
                <th style="width:26%">CO‚ÇÇ Factor (t/t)</th>
                <th style="width:26%">Consumption (t)</th>
                <th style="width:14%"></th>
              </tr>
            </thead>
            <tbody id="ciiFuelRows"></tbody>
          </table>

          <div class="flex space-between" style="margin-top:6px">
            <div class="flex" style="flex:1">
              <input id="ciiNewFuelName" placeholder="e.g. LNG" />
              <input id="ciiNewFuelFactor" type="number" step="0.001" placeholder="t CO‚ÇÇ/t" />
            </div>
            <button class="btn" onclick="ciiAddCustomFuel()">Ôºã Add Fuel</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:18px">
        <h3><span class="icon">üìä</span> Results</h3>
        <div class="grid-4">
          <div class="kpi">
            <div class="k">Total CO‚ÇÇ Emissions</div>
            <div class="v"><span id="ciiTotalCO2">0</span> t</div>
          </div>
          <div class="kpi">
            <div class="k">Attained CII</div>
            <div class="v" id="ciiAttained">0</div>
          </div>
          <div class="kpi">
            <div class="k">Required CII</div>
            <div class="v" id="ciiRequired">0</div>
          </div>
          <div class="kpi">
            <div class="k">CII Rating</div>
            <div class="rating-pill" id="ciiRating">-</div>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:18px">
        <div class="card">
          <h3>Attained vs Required CII ‚Äî Rating Bands</h3>
          <div class="chart-wrap"><canvas id="chartCiiBands"></canvas></div>
        </div>
        <div class="card">
          <h3>CO‚ÇÇ Emissions by Fuel Type</h3>
          <div class="chart-wrap"><canvas id="chartCiiFuelPie"></canvas></div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:18px">
        <div class="card">
          <h3>CII Grade vs Distance</h3>
          <div class="chart-wrap"><canvas id="chartCiiDistance"></canvas></div>
          <div class="hint">Shows how attained CII changes if annual distance changes (fuel & capacity fixed).</div>
        </div>

        <div class="card">
          <h3>Fuel Optimizer</h3>
          <div class="row" style="margin-top:4px">
            <div>
              <label>Replace fuel:</label>
              <select id="optFromFuel" onchange="ciiRecalcAll()"></select>
            </div>
            <div>
              <label>With:</label>
              <select id="optToFuel" onchange="ciiRecalcAll()">
                <option value="LNG">LNG</option>
                <option value="Methanol">Methanol</option>
                <option value="Biodiesel (FAME)">Biodiesel (FAME)</option>
                <option value="MGO/MDO">MGO/MDO</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Replacement: <span id="optPctLabel">30</span>%</label>
            <input id="optPct" type="range" min="0" max="100" value="30" oninput="ciiRecalcAll()" />
          </div>

          <div class="grid-3" style="margin-top:14px">
            <div class="kpi">
              <div class="k">New CII</div>
              <div class="v" id="optNewCii">-</div>
            </div>
            <div class="kpi">
              <div class="k">New Rating</div>
              <div class="rating-pill" id="optNewRating">-</div>
            </div>
            <div class="kpi">
              <div class="k">CO‚ÇÇ Saved</div>
              <div class="v" id="optSaved">0 t</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:18px">
        <div class="card">
          <h3>Multi-Year CII Trend (2023‚Äì2030)</h3>
          <div class="chart-wrap"><canvas id="chartCiiTrend"></canvas></div>
        </div>
        <div class="card">
          <h3>Fuel Mix Breakdown</h3>
          <div class="chart-wrap"><canvas id="chartCiiFuelDonut"></canvas></div>
        </div>
      </div>

      <div class="card" style="margin-top:18px">
        <h3>CII Rating Projection</h3>
        <div class="chart-wrap"><canvas id="chartCiiProjection"></canvas></div>
      </div>
    </section>

    <!-- ========================= EU ETS ========================= -->
    <section id="page-ets" class="section">
      <h1>EU ETS Calculator</h1>
      <p class="subtitle">Estimate your EU Emissions Trading System allowance costs per voyage.</p>

      <div class="card">
        <h3><span class="icon">‚öôÔ∏è</span> Configuration</h3>
        <div style="max-width:420px">
          <label>Carbon Price (‚Ç¨/tonne CO‚ÇÇ)</label>
          <input id="etsPrice" type="number" value="80" oninput="etsRecalcAll()" />
        </div>
      </div>

      <div class="card" style="margin-top:18px">
        <div class="flex space-between">
          <h3 style="margin:0"><span class="icon">üß≠</span> Voyage Legs</h3>
          <button class="btn" onclick="etsAddLeg()">Ôºã Add Voyage</button>
        </div>

        <table style="margin-top:8px">
          <thead>
            <tr>
              <th>From</th>
              <th>To</th>
              <th>EU Scope</th>
              <th>Fuel (t)</th>
              <th>CO‚ÇÇ Factor</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="etsLegRows"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:18px">
        <h3><span class="icon">üìà</span> Results</h3>
        <div class="grid-3">
          <div class="kpi">
            <div class="k">Total ETS CO‚ÇÇ</div>
            <div class="v"><span id="etsTotalCO2">0</span> t</div>
          </div>
          <div class="kpi">
            <div class="k">Total ETS Cost</div>
            <div class="v">‚Ç¨<span id="etsTotalCost">0</span></div>
          </div>
          <div class="kpi">
            <div class="k">Carbon Price</div>
            <div class="v">‚Ç¨<span id="etsPriceOut">0</span>/t</div>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:18px">
        <div class="card">
          <h3>ETS Emissions by Voyage</h3>
          <div class="chart-wrap"><canvas id="chartEtsEm"></canvas></div>
        </div>
        <div class="card">
          <h3>ETS Cost by Voyage</h3>
          <div class="chart-wrap"><canvas id="chartEtsCost"></canvas></div>
        </div>
      </div>
    </section>

    <!-- ========================= FUELEU ========================= -->
    <section id="page-fueleu" class="section">
      <h1>FuelEU Maritime</h1>
      <p class="subtitle">Calculate GHG intensity compliance under FuelEU Maritime regulations.</p>

      <div class="grid-2">
        <div class="card">
          <h3><span class="icon">‚õΩ</span> Energy & Fuel Inputs</h3>

          <div style="max-width:420px">
            <label>Reporting Year</label>
            <select id="feYear" onchange="feRecalcAll()">
              <option>2025</option>
              <option>2030</option>
              <option>2035</option>
              <option>2040</option>
              <option>2045</option>
              <option>2050</option>
            </select>
          </div>

          <div style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>Fuel Pathway</th>
                  <th>Tonnes</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="feFuelRows"></tbody>
            </table>
          </div>

          <button class="btn" onclick="feAddFuel()">Ôºã Add Fuel</button>
        </div>

        <div class="card">
          <h3><span class="icon">‚úÖ</span> Compliance Results</h3>

          <div class="grid-2" style="gap:14px">
            <div class="kpi">
              <div class="k">GHG Intensity</div>
              <div class="v"><span id="feIntensity">0</span></div>
              <div class="muted" style="font-size:12px; font-weight:800">gCO‚ÇÇeq/MJ</div>
            </div>
            <div class="kpi">
              <div class="k">Target (<span id="feTargetYear">2025</span>)</div>
              <div class="v"><span id="feTarget">0</span></div>
              <div class="muted" style="font-size:12px; font-weight:800">gCO‚ÇÇeq/MJ</div>
            </div>

            <div class="kpi">
              <div class="k">Compliance Balance</div>
              <div class="rating-pill" id="feBalancePill" style="background:#ef4444">Deficit</div>
              <div class="muted" style="font-size:12px; font-weight:800"><span id="feDelta">0</span> gCO‚ÇÇeq/MJ</div>
            </div>
            <div class="kpi">
              <div class="k">Est. Penalty</div>
              <div class="v">‚Ç¨<span id="fePenalty">0</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:18px">
        <div class="card">
          <h3>GHG Intensity vs Target Over Years</h3>
          <div class="chart-wrap"><canvas id="chartFeTargets"></canvas></div>
        </div>
        <div class="card">
          <h3>Fuel Pathway Comparison</h3>
          <div class="chart-wrap"><canvas id="chartFeCompare"></canvas></div>
        </div>
      </div>
    </section>

    <!-- ========================= WHO ========================= -->
    <section id="page-who" class="section">
      <h1>Who We Are</h1>
      <p class="subtitle">
        We're a team of maritime professionals and technologists committed to helping the shipping industry navigate environmental regulations.
        Our tools simplify CII, EU ETS, and FuelEU Maritime calculations so operators can focus on what matters ‚Äî running efficient, compliant vessels.
      </p>

      <div class="team-grid">
        <div class="card who-card">
          <div class="avatar">AP</div>
          <h4>Alexandros Papadopoulos</h4>
          <div class="role">Founder & Naval Architect</div>
          <p>Over 15 years of experience in maritime engineering and environmental compliance. Passionate about helping the shipping industry transition to cleaner operations.</p>
        </div>
        <div class="card who-card">
          <div class="avatar">MK</div>
          <h4>Maria Konstantinou</h4>
          <div class="role">Environmental Compliance Lead</div>
          <p>Specialist in IMO regulations, EU ETS, and FuelEU Maritime. Dedicated to making complex regulatory frameworks accessible to ship operators worldwide.</p>
        </div>
        <div class="card who-card">
          <div class="avatar">NG</div>
          <h4>Nikos Georgiou</h4>
          <div class="role">Data Analyst & Developer</div>
          <p>Full-stack developer with a background in maritime data analytics. Builds the tools that turn complex calculations into actionable insights.</p>
        </div>
      </div>

      <div class="card center" style="margin-top:22px">
        <h2 style="margin:6px 0 0">Get in Touch</h2>
        <p class="muted" style="margin:8px 0 0">Have questions or want to learn more? Reach out to us.</p>
        <div style="margin-top:12px; font-weight:900; color:var(--navy2)">
          ‚úâÔ∏è info@maritimecii.com
        </div>
      </div>
    </section>

  </div>

  <div class="footer">¬© <span id="yr"></span> MaritimeCII. All rights reserved.</div>

<script>
/* =========================
   NAV / ROUTER (simple)
========================= */
document.getElementById("yr").textContent = new Date().getFullYear();

function go(which){
  const pages = ["cii","ets","fueleu","who"];
  pages.forEach(p=>{
    document.getElementById("page-"+p).classList.remove("active");
    document.getElementById("tab-"+(p==="ets"?"ets":p)).classList.remove("active");
  });
  document.getElementById("page-"+which).classList.add("active");
  document.getElementById("tab-"+(which==="ets"?"ets":which)).classList.add("active");
  window.scrollTo({top:0, behavior:"smooth"});
}
window.addEventListener("hashchange", ()=>{
  const h = location.hash.replace("#","");
  if(h==="eu-ets") go("ets");
  else if(h==="fueleu") go("fueleu");
  else if(h==="who") go("who");
  else go("cii");
});

/* =========================
   COMMON HELPERS
========================= */
function n(x, d=0){
  const v = Number(x);
  if(Number.isFinite(v)) return v;
  return d;
}
function fmt(x, digits=4){
  if(!Number.isFinite(x)) return "0";
  return x.toFixed(digits);
}
function fmt0(x){
  if(!Number.isFinite(x)) return "0";
  return Math.round(x).toString();
}

/* =========================
   CII CALC (IMO-style)
   Attained CII = (total CO2 grams) / (capacity * distance) * corrFactor
   Required CII:
     ref = a * capacity^(-c)
     required = ref * (1 - Z(year))
   Rating bands:
     A <= required*exp(d1)
     B <= required*exp(d2)
     C <= required*exp(d3)
     D <= required*exp(d4)
     else E
   Coeff: based on IMO MEPC.337(76)
   d1..d4: MEPC.339(76)
========================= */
const CII_COEFF = {
  // a, c (reference line)
  // Values commonly used from MEPC.337(76) Table 1 (best-effort mapping for demo UI)
  // Bulk carrier etc.
  bulk_carrier:     {a: 4745, c: 0.622},
  tanker:           {a: 5247, c: 0.610},
  container:        {a: 1984, c: 0.489},
  gas_carrier:      {a: 8104, c: 0.639},
  general_cargo:    {a: 3199, c: 0.644},
  refrigerated_cargo:{a: 4600, c: 0.557},
  ro_ro_cargo:      {a: 1975, c: 0.529},
  ro_ro_passenger:  {a: 1500, c: 0.500},
  cruise:           {a: 930,  c: 0.383}
};

// Reduction factor Z by year (2023-2030), IMO tightening schedule (MEPC.400(83))
// Note: These are the standard annual reduction factors used for required CII calculation.
const CII_Z = {
  2023: 0.05,
  2024: 0.07,
  2025: 0.09,
  2026: 0.11,
  2027: 0.13,
  2028: 0.15,
  2029: 0.17,
  2030: 0.19
};

// Rating boundaries multipliers (dd vector) from MEPC.339(76)
// Here applied via exp(d) approach (typical implementation).
const CII_D = { d1: -0.387, d2: -0.172, d3: 0.000, d4: 0.172 }; // baseline; C is 0
function ratingBands(required){
  const A = required * Math.exp(CII_D.d1);
  const B = required * Math.exp(CII_D.d2);
  const C = required * Math.exp(CII_D.d3);
  const D = required * Math.exp(CII_D.d4);
  return {A,B,C,D,E: Infinity};
}
function gradeFromAttained(attained, required){
  const b = ratingBands(required);
  if(attained <= b.A) return "A";
  if(attained <= b.B) return "B";
  if(attained <= b.C) return "C";
  if(attained <= b.D) return "D";
  return "E";
}

/* Fuels: default + factors (tCO2 per tonne fuel) */
const FUEL_FACTORS = {
  "HFO": 3.114,
  "MGO/MDO": 3.206,
  "LFO": 3.151,
  "LNG": 2.750,
  "Methanol": 1.375,
  "Biodiesel (FAME)": 2.800
};

/* CII state */
let ciiFuels = [
  {name:"HFO", factor:FUEL_FACTORS["HFO"], t:2000},
  {name:"MGO/MDO", factor:FUEL_FACTORS["MGO/MDO"], t:400},
  {name:"LFO", factor:FUEL_FACTORS["LFO"], t:4000},
];

function ciiRenderFuelRows(){
  const tb = document.getElementById("ciiFuelRows");
  tb.innerHTML = "";
  ciiFuels.forEach((f, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.name}</td>
      <td class="td-input"><input type="number" step="0.001" value="${f.factor}" oninput="ciiUpdateFuel(${idx}, 'factor', this.value)"></td>
      <td class="td-input"><input type="number" step="1" value="${f.t}" oninput="ciiUpdateFuel(${idx}, 't', this.value)"></td>
      <td class="td-actions">
        <button class="btn small danger" onclick="ciiRemoveFuel(${idx})">üóë</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // optimizer dropdowns
  const optFrom = document.getElementById("optFromFuel");
  const prev = optFrom.value || (ciiFuels[0]?.name ?? "");
  optFrom.innerHTML = "";
  ciiFuels.forEach(f=>{
    const o = document.createElement("option");
    o.value = f.name; o.textContent = f.name;
    optFrom.appendChild(o);
  });
  optFrom.value = prev || (ciiFuels[0]?.name ?? "");
}

function ciiUpdateFuel(idx, key, val){
  ciiFuels[idx][key] = n(val, 0);
  ciiRecalcAll();
}
function ciiRemoveFuel(idx){
  ciiFuels.splice(idx,1);
  ciiRenderFuelRows();
  ciiRecalcAll();
}
function ciiAddCustomFuel(){
  const name = document.getElementById("ciiNewFuelName").value.trim();
  const factor = n(document.getElementById("ciiNewFuelFactor").value, NaN);
  if(!name || !Number.isFinite(factor)) return;
  ciiFuels.push({name, factor, t:0});
  document.getElementById("ciiNewFuelName").value = "";
  document.getElementById("ciiNewFuelFactor").value = "";
  ciiRenderFuelRows();
  ciiRecalcAll();
}

function ciiTotalCO2(){
  // total CO2 (t) = sum(fuel_t * factor)
  return ciiFuels.reduce((s,f)=> s + n(f.t)*n(f.factor), 0);
}
function ciiRequired(){
  const type = document.getElementById("ciiShipType").value;
  const year = n(document.getElementById("ciiYear").value, 2025);
  const cap = Math.max(1, n(document.getElementById("ciiCapacity").value, 1));
  const coeff = CII_COEFF[type] || CII_COEFF.bulk_carrier;

  const ref = coeff.a * Math.pow(cap, -coeff.c);
  const Z = (CII_Z[year] ?? CII_Z[2025]);
  return ref * (1 - Z);
}
function ciiAttained(totalCO2_t){
  const cap = Math.max(1, n(document.getElementById("ciiCapacity").value, 1));
  const dist = Math.max(1, n(document.getElementById("ciiDistance").value, 1));
  const corr = Math.max(0, n(document.getElementById("ciiCorr").value, 1));
  // grams / (capacity*distance)
  const grams = totalCO2_t * 1e6;
  return (grams / (cap * dist)) * corr;
}

/* Optimizer */
function ciiOptimizer(baseTotalCO2){
  const fromFuel = document.getElementById("optFromFuel").value;
  const toFuel = document.getElementById("optToFuel").value;
  const pct = n(document.getElementById("optPct").value, 0);
  document.getElementById("optPctLabel").textContent = pct;

  const from = ciiFuels.find(x=>x.name===fromFuel);
  if(!from){
    return {newCO2: baseTotalCO2, saved:0};
  }
  const toFactor = FUEL_FACTORS[toFuel] ?? 0;
  const replaceFrac = pct / 100;

  // Replace fraction of FROM fuel tonnes with TO fuel tonnes (same tonnes).
  const fromCO2 = from.t * from.factor;
  const replacedCO2 = (from.t * replaceFrac) * toFactor;
  const remainingCO2 = (from.t * (1-replaceFrac)) * from.factor;

  const newTotal = baseTotalCO2 - fromCO2 + (replacedCO2 + remainingCO2);
  const saved = baseTotalCO2 - newTotal;
  return {newCO2: newTotal, saved};
}

/* Charts (CII) */
let chartCiiBands, chartCiiFuelPie, chartCiiDistance, chartCiiTrend, chartCiiFuelDonut, chartCiiProjection;

function ensureCiiCharts(){
  if(!chartCiiBands){
    chartCiiBands = new Chart(document.getElementById("chartCiiBands"), {
      type:"bar",
      data:{
        labels:["A","B","C","D","E"],
        datasets:[{label:"Band Limit", data:[1,1,1,1,1]}]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          x:{grid:{display:false}},
          y:{beginAtZero:true}
        }
      }
    });
  }
  if(!chartCiiFuelPie){
    chartCiiFuelPie = new Chart(document.getElementById("chartCiiFuelPie"), {
      type:"pie",
      data:{labels:[], datasets:[{data:[]}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}}
    });
  }
  if(!chartCiiFuelDonut){
    chartCiiFuelDonut = new Chart(document.getElementById('chartCiiFuelDonut'), {
      type:"doughnut",
      data:{labels:[], datasets:[{data:[]}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}}
    });
  }
  if(!chartCiiDistance){
    chartCiiDistance = new Chart(document.getElementById("chartCiiDistance"), {
      type:"line",
      data:{labels:[], datasets:[{label:"Attained CII", data:[], tension:.35}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}
      }
    });
  }
  if(!chartCiiTrend){
    chartCiiTrend = new Chart(document.getElementById("chartCiiTrend"), {
      type:"line",
      data:{
        labels:["2023","2024","2025","2026","2027","2028","2029","2030"],
        datasets:[
          {label:"Required CII", data:[], tension:.35},
          {label:"Attained CII", data:[], tension:.35}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{position:"bottom"}},
        scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}
      }
    });
  }
  if(!chartCiiProjection){
    chartCiiProjection = new Chart(document.getElementById("chartCiiProjection"), {
      type:"bar",
      data:{
        labels:["2023","2024","2025","2026","2027","2028","2029","2030"],
        datasets:[{label:"Rating (A=1..E=5)", data:[]}]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}},
        scales:{
          x:{grid:{display:false}},
          y:{
            beginAtZero:true,
            ticks:{
              callback:(v)=>{
                const m = {1:"A",2:"B",3:"C",4:"D",5:"E"};
                return m[v] ?? v;
              },
              stepSize:1
            },
            suggestedMax:5
          }
        }
      }
    });
  }
}

function ciiUpdateCharts(required, attained, totalCO2){
  ensureCiiCharts();

  // Bands bar chart: show boundary values as bars with a vertical line-like effect via annotation is extra,
  // so we plot bar heights and show attained/required via titles text.
  const b = ratingBands(required);
  chartCiiBands.data.labels = ["A","B","C","D","E"];
  chartCiiBands.data.datasets[0].data = [b.A, b.B, b.C, b.D, required*1.8];
  chartCiiBands.options.plugins.title = {
    display:true,
    text:`Required: ${fmt(required,4)} | Attained: ${fmt(attained,4)}`
  };
  chartCiiBands.update();

  // Fuel pie/donut
  const labels = ciiFuels.map(f=>f.name);
  const co2parts = ciiFuels.map(f=> n(f.t)*n(f.factor));
  chartCiiFuelPie.data.labels = labels;
  chartCiiFuelPie.data.datasets[0].data = co2parts;
  chartCiiFuelPie.update();

  chartCiiFuelDonut.data.labels = labels;
  chartCiiFuelDonut.data.datasets[0].data = co2parts;
  chartCiiFuelDonut.update();

  // CII vs distance curve
  const dist = Math.max(1, n(document.getElementById("ciiDistance").value, 10000));
  const base = totalCO2 * 1e6; // grams
  const cap = Math.max(1, n(document.getElementById("ciiCapacity").value, 1));
  const corr = Math.max(0, n(document.getElementById("ciiCorr").value, 1));

  const xs = [];
  const ys = [];
  // from 4k to 25k like screenshot
  for(let d=4000; d<=25000; d+=1000){
    xs.push((d/1000)+"k");
    ys.push((base/(cap*d))*corr);
  }
  chartCiiDistance.data.labels = xs;
  chartCiiDistance.data.datasets[0].data = ys;
  chartCiiDistance.update();

  // Multi-year trend
  const years = [2023,2024,2025,2026,2027,2028,2029,2030];
  const type = document.getElementById("ciiShipType").value;
  const coeff = CII_COEFF[type] || CII_COEFF.bulk_carrier;
  const reqs = years.map(y=>{
    const ref = coeff.a * Math.pow(cap, -coeff.c);
    const Z = (CII_Z[y] ?? CII_Z[2025]);
    return ref * (1 - Z);
  });
  const att = years.map(_y=>attained); // assume same attained each year for display
  chartCiiTrend.data.datasets[0].data = reqs;
  chartCiiTrend.data.datasets[1].data = att;
  chartCiiTrend.update();

  // Rating projection
  const score = (g)=> ({A:1,B:2,C:3,D:4,E:5}[g]||5);
  const grades = reqs.map(r=>gradeFromAttained(attained, r));
  chartCiiProjection.data.datasets[0].data = grades.map(score);
  chartCiiProjection.update();
}

function ciiRecalcAll(){
  ciiRenderFuelRows();

  const totalCO2 = ciiTotalCO2();
  const required = ciiRequired();
  const attained = ciiAttained(totalCO2);
  const grade = gradeFromAttained(attained, required);

  document.getElementById("ciiTotalCO2").textContent = fmt(totalCO2,1);
  document.getElementById("ciiAttained").textContent = fmt(attained,4);
  document.getElementById("ciiRequired").textContent = fmt(required,4);
  document.getElementById("ciiRating").textContent = grade;

  // Optimizer
  const opt = ciiOptimizer(totalCO2);
  const newAtt = ciiAttained(opt.newCO2);
  const newGrade = gradeFromAttained(newAtt, required);

  document.getElementById("optNewCii").textContent = fmt(newAtt,4);
  document.getElementById("optNewRating").textContent = newGrade;
  document.getElementById("optSaved").textContent = (opt.saved>=0? "-":"") + fmt(Math.abs(opt.saved),0) + " t";

  ciiUpdateCharts(required, attained, totalCO2);
}

/* =========================
   ETS
========================= */
let etsLegs = [
  {from:"Rotterdam", to:"Hamburg", scope:"intra", fuelT:500, factor:3.114}
];

function etsScopeFrac(scope){
  // Intra-EU 100%, Extra-EU 50%, At-berth 100%
  if(scope==="intra") return 1.0;
  if(scope==="extra") return 0.5;
  if(scope==="berth") return 1.0;
  return 1.0;
}

function etsRenderLegs(){
  const tb = document.getElementById("etsLegRows");
  tb.innerHTML="";
  etsLegs.forEach((v, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="td-input"><input value="${v.from}" oninput="etsUpdate(${idx}, 'from', this.value)"></td>
      <td class="td-input"><input value="${v.to}" oninput="etsUpdate(${idx}, 'to', this.value)"></td>
      <td class="td-input">
        <select onchange="etsUpdate(${idx}, 'scope', this.value)">
          <option value="intra" ${v.scope==="intra"?"selected":""}>Intra-EU (100%)</option>
          <option value="extra" ${v.scope==="extra"?"selected":""}>Extra-EU (50%)</option>
          <option value="berth" ${v.scope==="berth"?"selected":""}>At Berth (100%)</option>
        </select>
      </td>
      <td class="td-input"><input type="number" value="${v.fuelT}" oninput="etsUpdate(${idx}, 'fuelT', this.value)"></td>
      <td class="td-input"><input type="number" step="0.001" value="${v.factor}" oninput="etsUpdate(${idx}, 'factor', this.value)"></td>
      <td class="td-actions"><button class="btn small danger" onclick="etsRemove(${idx})">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
}
function etsUpdate(idx, key, val){
  if(key==="fuelT" || key==="factor") etsLegs[idx][key] = n(val,0);
  else etsLegs[idx][key] = val;
  etsRecalcAll();
}
function etsRemove(idx){
  etsLegs.splice(idx,1);
  etsRenderLegs();
  etsRecalcAll();
}
function etsAddLeg(){
  etsLegs.push({from:"", to:"", scope:"intra", fuelT:0, factor:3.114});
  etsRenderLegs();
  etsRecalcAll();
}

let chartEtsEm, chartEtsCost;
function ensureEtsCharts(){
  if(!chartEtsEm){
    chartEtsEm = new Chart(document.getElementById("chartEtsEm"),{
      type:"bar",
      data:{labels:[], datasets:[{label:"ETS CO‚ÇÇ (t)", data:[]}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}}
    });
  }
  if(!chartEtsCost){
    chartEtsCost = new Chart(document.getElementById("chartEtsCost"),{
      type:"bar",
      data:{labels:[], datasets:[{label:"ETS Cost (‚Ç¨)", data:[]}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}}
    });
  }
}
function etsRecalcAll(){
  etsRenderLegs();
  ensureEtsCharts();

  const price = n(document.getElementById("etsPrice").value, 0);
  document.getElementById("etsPriceOut").textContent = fmt0(price);

  const perLegCO2 = etsLegs.map(v => (n(v.fuelT)*n(v.factor))*etsScopeFrac(v.scope));
  const perLegCost = perLegCO2.map(c=>c*price);

  const totalCO2 = perLegCO2.reduce((a,b)=>a+b,0);
  const totalCost = perLegCost.reduce((a,b)=>a+b,0);

  document.getElementById("etsTotalCO2").textContent = fmt(totalCO2,1);
  document.getElementById("etsTotalCost").textContent = fmt0(totalCost);

  const labels = etsLegs.map(v=> `${v.from || "‚Äî"} ‚Üí ${v.to || "‚Äî"}`);
  chartEtsEm.data.labels = labels;
  chartEtsEm.data.datasets[0].data = perLegCO2;
  chartEtsEm.update();

  chartEtsCost.data.labels = labels;
  chartEtsCost.data.datasets[0].data = perLegCost;
  chartEtsCost.update();
}

/* =========================
   FUELEU
   Simple model:
   - Map fuel tonnes -> MJ using lower heating values (LHV)
   - Intensity = sum(energy * pathwayIntensity)/totalEnergy
   - Target table based on FuelEU reductions
   - Penalty: simple proxy (not legal): delta * totalEnergy * penaltyFactor
========================= */
const FE_PATHWAYS = [
  {name:"HFO", intensity:91.10, lhvMJperKg:40.2},
  {name:"MGO/MDO", intensity:91.00, lhvMJperKg:42.7},
  {name:"LFO", intensity:90.80, lhvMJperKg:41.0},
  {name:"LNG", intensity:75.00, lhvMJperKg:50.0},
  {name:"Methanol (fossil)", intensity:94.00, lhvMJperKg:19.9},
  {name:"Methanol (bio)", intensity:20.00, lhvMJperKg:19.9},
  {name:"Biodiesel (FAME)", intensity:40.00, lhvMJperKg:37.0},
  {name:"e-Ammonia", intensity:5.00, lhvMJperKg:18.6}
];

// Targets (gCO2eq/MJ). 2025 shown in your screenshot: 89.34.
const FE_TARGET = {
  2025: 89.34,
  2030: 80.00,
  2035: 67.00,
  2040: 55.00,
  2045: 33.00,
  2050: 14.00
};

let feFuels = [{path:"HFO", tonnes:5000}];

function feRender(){
  const tb = document.getElementById("feFuelRows");
  tb.innerHTML="";
  feFuels.forEach((f, idx)=>{
    const tr = document.createElement("tr");
    const options = FE_PATHWAYS.map(p=>{
      const sel = p.name===f.path ? "selected":"";
      return `<option ${sel} value="${p.name}">${p.name}</option>`;
    }).join("");
    tr.innerHTML = `
      <td class="td-input">
        <select onchange="feUpdate(${idx}, 'path', this.value)">${options}</select>
      </td>
      <td class="td-input"><input type="number" value="${f.tonnes}" oninput="feUpdate(${idx}, 'tonnes', this.value)"></td>
      <td class="td-actions"><button class="btn small danger" onclick="feRemove(${idx})">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
}
function feUpdate(idx, key, val){
  if(key==="tonnes") feFuels[idx][key] = n(val,0);
  else feFuels[idx][key] = val;
  feRecalcAll();
}
function feRemove(idx){
  feFuels.splice(idx,1);
  feRender();
  feRecalcAll();
}
function feAddFuel(){
  feFuels.push({path:"HFO", tonnes:0});
  feRender();
  feRecalcAll();
}

let chartFeTargets, chartFeCompare;
function ensureFeCharts(){
  if(!chartFeTargets){
    chartFeTargets = new Chart(document.getElementById("chartFeTargets"),{
      type:"bar",
      data:{labels:["2025","2030","2035","2040","2045","2050"], datasets:[{label:"FuelEU Target", data:[]}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}}
    });
  }
  if(!chartFeCompare){
    chartFeCompare = new Chart(document.getElementById("chartFeCompare"),{
      type:"bar",
      data:{labels:[], datasets:[{label:"Pathway intensity (gCO‚ÇÇeq/MJ)", data:[]}]},
      options:{responsive:true, maintainAspectRatio:false, indexAxis:"y", plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}}}
    });
  }
}

function feCalc(){
  // energy MJ = tonnes * 1e6 g -> kg = tonnes*1000 => kg * LHV(MJ/kg)
  let totalE = 0;
  let weighted = 0;
  feFuels.forEach(f=>{
    const p = FE_PATHWAYS.find(x=>x.name===f.path);
    if(!p) return;
    const kg = n(f.tonnes)*1000;
    const E = kg * p.lhvMJperKg;
    totalE += E;
    weighted += E * p.intensity;
  });
  const intensity = totalE>0 ? (weighted/totalE) : 0;
  return {totalE, intensity};
}

function feRecalcAll(){
  feRender();
  ensureFeCharts();

  const year = n(document.getElementById("feYear").value, 2025);
  const target = FE_TARGET[year] ?? FE_TARGET[2025];
  document.getElementById("feTargetYear").textContent = year;
  document.getElementById("feTarget").textContent = fmt(target,2);

  const {totalE, intensity} = feCalc();
  document.getElementById("feIntensity").textContent = fmt(intensity,2);

  const delta = intensity - target; // positive means deficit
  document.getElementById("feDelta").textContent = fmt(Math.abs(delta),2);

  const pill = document.getElementById("feBalancePill");
  if(delta <= 0){
    pill.textContent = "Surplus";
    pill.style.background = "#16a34a";
  }else{
    pill.textContent = "Deficit";
    pill.style.background = "#ef4444";
  }

  // Penalty proxy (not legal): 0.0003 ‚Ç¨/MJ per (gCO2eq/MJ) over target
  const penalty = Math.max(0, delta) * totalE * 0.0003;
  document.getElementById("fePenalty").textContent = fmt0(penalty);

  // Targets chart
  const years = ["2025","2030","2035","2040","2045","2050"];
  chartFeTargets.data.datasets[0].data = years.map(y=>FE_TARGET[Number(y)]);
  chartFeTargets.update();

  // Comparison chart (all pathways)
  chartFeCompare.data.labels = FE_PATHWAYS.map(p=>p.name);
  chartFeCompare.data.datasets[0].data = FE_PATHWAYS.map(p=>p.intensity);
  chartFeCompare.update();
}

/* =========================
   INIT
========================= */
ciiRenderFuelRows();
etsRenderLegs();
feRender();

ciiRecalcAll();
etsRecalcAll();
feRecalcAll();

// Hash routing init
(() => {
  const h = location.hash.replace("#","");
  if(h==="eu-ets") go("ets");
  else if(h==="fueleu") go("fueleu");
  else if(h==="who") go("who");
  else go("cii");
})();
</script>

</body>
</html>
